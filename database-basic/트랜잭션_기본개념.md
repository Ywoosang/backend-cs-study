# 트랜잭션

## 트랜잭션이란?

DBMS 에서 트랜잭션은 하나의 그룹으로 처리되어야 하는 명령문을 모아놓은 논리적인 작업 단위다.

![img](../images/Transaction(1).png)

여러 SQL 명령어를 하나의 그룹으로 묶어 처리하며, 이 그룹이 전체적으로 성공하거나 전체적으로 실패하는 것을 보장한다. 
즉, 트랜잭션 내의 작업들이 모두 성공적으로 완료되면 데이터베이스에 그 결과를 반영하고, 만약 하나라도 오류가 발생하면 모든 작업을 취소해 데이터의 일관성을 유지한다.

## 트랜잭션을 사용하는 이유

데이터의 일관성을 유지하면서 안정적으로 데이터를 복구하기 위함이다. 데이터베이스에선 테이블에서 데이터를 읽어 온 후 다른 테이블에 데이터를 입력하거나 갱신, 삭제하는데 처리 도중 오류가 발생하면 모든 작업을 원상태로 되돌린다. 
처리 과정이 모두 성공했을 때만 최종적으로 데이터베이스에 반영한다.

## 트랜잭션 처리 과정

1. 트랜잭션 시작: 트랜잭션이 시작되면, 여러 SQL 명령어들이 실행되기 시작한다.
2. 명령어 실행: 트랜잭션 내에서 SQL 명령어들이 실행되며 데이터가 변경된다.
3. 커밋(Commit): 트랜잭션 내의 모든 명령어가 성공적으로 실행되면, 커밋 명령어를 통해 데이터베이스에 영구적으로 반영된다.
4. 롤백(Rollback): 트랜잭션 내의 어느 한 명령어라도 실패하면, 롤백 명령어가 실행되어 트랜잭션 시작 이전 상태로 되돌린다.

## 트랜잭션의 특성 (ACID)

ACID는 데이터의 유효성을 보장하기 위한, 트랜젝션의 특징들의 앞글자를 딴 단어다.

### 원자성 (Atomicity)

트랜잭션의 모든 연산은 전부 성공적으로 실행되거나 전혀 실행되지 않아야 한다. 
- ex) 계좌 이체 시 출금과 입금이 모두 성공해야 하며, 하나라도 실패하면 전체 트랜잭션이 취소되어야 한다.

### 일관성 (Consistency)

트랜잭션이 실행된 후 데이터베이스는 항상 일관된 상태를 유지해야 한다. 즉, 데이터베이스의 제약 조건이나 규칙을 위반하지 않아야 한다.
- ex) 계좌 잔액은 항상 0 이상이어야 한다는 규칙이 있다면, 이체 후에도 규칙이 지켜져야 한다.

### 독립성 (Isolation)

동시에 실행되는 트랜잭션들은 서로 독립적으로 실행되어야 한다. 하나의 트랜잭션이 실행되는 동안 다른 트랜잭션이 그 결과를 참조할 수 없어야 한다. (격리 수준에 따라 동시성 제어 방식이 달라진다.)
- ex) 사용자 A의 계좌 이체가 진행 중일 때, 사용자 B가 같은 계좌의 잔액을 조회해도 영향을 받지 않아야 한다.

### 영속성 (Durability)

성공적으로 완료된 트랜잭션의 결과는 시스템이 고장나더라도 영구적으로 반영되어야 한다. 즉, 데이터베이스에 저장된 정보는 항상 안전하게 보존되어야 한다.
- ex) 계좌 이체가 완료된 후 시스템이 다운되더라도, 재시작 후에도 이체 결과가 유지되어야 한다.

## 트랜잭션을 사용할 때 주의해야 할 점

1. 트랜잭션은 꼭 필요한 최소한의 범위에만 적용하는 것이 좋다. 트랜잭션의 범위가 넓어지면 데이터베이스 커넥션을 오래 점유하게 되어 다른 작업에 영향을 미칠 수 있다. 같은 맥락으로 트랜잭션 내에서 네트워크 작업이나 긴 시간이 소요되는 작업은 피하는 것이 좋다.
2. 데이터베이스의 격리 수준을 적절하게 설정해야 한다. 격리 수준이 낮으면 성능은 좋아지자만 데이터의 일관성이 깨질 수 있으므로 주의한다.
3. 트랜잭션이 완료되지 않으면 데이터베이스 리소스가 불필요하게 점유될 수 있으므로, 트랜잭션 완료 시 반드시 COMMIT 또는 ROLLBACK 을 실행해야 한다.
4. 데드락을 방지하기 위해 정해진 순서로 테이블에 접근하고, 읽기 잠금 획득(SELECT FOR UPDATE) 사용을 최소화해야 한다.

